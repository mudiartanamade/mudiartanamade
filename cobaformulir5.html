<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Pendaftaran Siswa Baru SD - Kota Denpasar</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background-color:#f4f7f6;margin:0;padding:20px;color:#333}
        .form-container{max-width:700px;margin:auto;background-color:#fff;padding:25px 30px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.1);border-top:5px solid #007bff; overflow: hidden;}
        .form-header img{width:100px;height:auto;margin-bottom:10px}
        .form-header h2{color:#007bff;font-size:24px;margin:0}
        fieldset{border:1px solid #ddd;padding:15px;margin-bottom:20px;border-radius:5px}
        legend{font-weight:700;color:#0056b3;padding:0 10px}
        .input-group{margin-bottom:15px}
        .input-group label{display:block;margin-bottom:8px;font-weight:600;color:#555}
        .is-required::after {content: " *";color: #dc3545;font-weight: bold;}
        .input-group input[type=text],.input-group input[type=number],.input-group input[type=date],.input-group input[type=tel],.input-group input[type=email],.input-group select,.input-group textarea, .select2-container {width: 100% !important;box-sizing: border-box;}
        .input-group input[type=text],.input-group input[type=number],.input-group input[type=date],.input-group input[type=tel],.input-group input[type=email],.input-group textarea{padding:10px;border-radius:5px;border:1px solid #ccc;font-size:16px;}
        .input-group input:read-only{background-color:#e9ecef}
        .input-group select:disabled, .input-group input:disabled {background-color:#e9ecef;cursor:not-allowed}
        .button-group{display:flex;flex-wrap: wrap; gap:10px;margin-top:20px}
        .submit-btn, .edit-btn, .next-btn {flex-grow:1;padding:12px;border:none;border-radius:5px;color:#fff;font-size:18px;font-weight:700;cursor:pointer;transition:background-color .3s ease; min-width: 200px;}
        .submit-btn{background-color:#007bff}
        .edit-btn{background-color:#6c757d}
        .next-btn { background-color: #28a745; text-align: center;}
        .submit-btn:hover{background-color:#0056b3}
        .edit-btn:hover{background-color:#5a6268}
        .next-btn:hover { background-color: #218838; }
        .submit-btn:disabled{background-color:#a5d8ff;cursor:not-allowed;}
        .next-btn:disabled{background-color:#90d69b; cursor: not-allowed;}
        .edit-btn:disabled{background-color:#c8cbcf; cursor: not-allowed;}
        .popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
        .popup-content{background:#fff;padding:30px;border-radius:8px;box-shadow:0 5px 20px rgba(0,0,0,.2);text-align:center;max-width:450px;width:90%;position:relative;transform:scale(.9);opacity:0;transition:transform .3s ease, opacity .3s ease}
        .popup-content.show{transform:scale(1);opacity:1}
        .popup-content .close-btn{position:absolute;top:10px;right:15px;font-size:28px;font-weight:700;color:#aaa;cursor:pointer;line-height:1}
        .popup-content .close-btn:hover{color:#333}
        #popup-message{margin-top:15px;font-size:16px;line-height:1.5; color: #555;}
        #popup-message a{color:#0056b3;font-weight:700;text-decoration:underline}
        #popup-icon{margin-bottom:15px; min-height: 50px; display: flex; align-items: center; justify-content: center;}
        .spinner {width: 48px;height: 48px;border: 5px solid #f3f3f3;border-top: 5px solid #007bff;border-radius: 50%;animation: spin 1s linear infinite;}
        @keyframes spin {0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}
        .select2-container .select2-selection--single{height:40px!important;padding:4px 0}
        .select2-container--default .select2-selection--single .select2-selection__arrow{height:38px!important}
        .select2-container--default .select2-selection--single .select2-selection__rendered {line-height: 30px !important;}
        .select2-results__option { padding: 8px;}
    </style>
</head>
<body>
    <div class="form-container">
        <center class="form-header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/Lambang_Kota_Denpasar_%281%29.png/1077px-Lambang_Kota_Denpasar_%281%29.png" alt="Logo Kota Denpasar">
            <div>
                <h2>Formulir Pendaftaran Murid Baru SD Negeri Kota Denpasar</h2>
                <p style="text-align:center; margin-top:5px; margin-bottom: 25px;">Tahun Ajaran 2026/2027</p>
            </div>
        </center>
        
        <form name="form-pendaftaran-sd" id="pendaftaranForm">
            <input type="hidden" name="editNik" id="editNik">
            
            <fieldset id="fieldset-a">
                <legend><strong>A. Verifikasi Admin Sekolah</strong></legend>
                <div class="input-group"><label for="token">Masukkan Token</label><input type="text" id="token" name="token" pattern="[A-Z0-9]{8}" title="Token harus 8 karakter kombinasi huruf kapital dan angka." required></div>
                <div class="button-group">
                    <button type="button" class="edit-btn edit-trigger" disabled>✏️ Edit Data</button>
                    <button type="button" class="next-btn" id="next-to-b" data-current="fieldset-a" data-next="fieldset-b" disabled>Selanjutnya ➡️</button>
                </div>
            </fieldset>

            <fieldset id="fieldset-b" style="display:none;">
                <legend><strong>B. Data Diri Calon Siswa</strong></legend>
                <div class="input-group"><label for="namaLengkap">Nama Lengkap</label><input type="text" id="namaLengkap" name="namaLengkap" placeholder="Sesuai Akta Kelahiran" required></div>
                <div class="input-group"><label for="nik">Nomor Induk Kependudukan (NIK)</label><input type="text" id="nik" name="nik" pattern="\d{16}" title="NIK harus terdiri dari 16 digit angka" placeholder="16 digit angka" required></div>
                <div class="input-group"><label for="nisn">Nomor Induk Siswa Nasional (NISN)</label><input type="text" id="nisn" name="nisn" pattern="\d{10}" title="NISN harus terdiri dari 10 digit angka" placeholder="Jika ada"></div>
                <div class="input-group"><label for="jenisKelamin">Jenis Kelamin</label><select id="jenisKelamin" name="jenisKelamin" required><option value="" disabled selected>Pilih Jenis Kelamin</option><option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option></select></div>
                <div class="input-group"><label for="tempatLahir">Tempat Lahir</label><input type="text" id="tempatLahir" name="tempatLahir" placeholder="Contoh: Denpasar" required></div>
                <div class="input-group"><label for="tanggalLahir">Tanggal Lahir</label><input type="date" id="tanggalLahir" name="tanggalLahir" required></div>
                <button type="button" class="next-btn" data-current="fieldset-b" data-next="fieldset-c">Selanjutnya ➡️</button>
            </fieldset>

            <fieldset id="fieldset-c" style="display:none;">
                <legend><strong>C. Alamat Tinggal (Sesuai KK)</strong></legend>
                <div class="input-group"><label for="kategoriKK">Kategori KK</label><select id="kategoriKK" name="kategoriKK" required><option></option><option value="KK Denpasar">KK Denpasar</option><option value="KK Luar Denpasar">KK Luar Denpasar</option></select></div>
                <div class="input-group" id="provinsi-group" style="display:none;"><label for="provinsi">Provinsi</label><select id="provinsi" name="provinsi"><option value="" disabled selected>Pilih Provinsi Asal</option><option value="Bali">Bali</option><option value="Luar Bali">Luar Bali</option></select></div>
                <div class="input-group"><label for="alamat">Alamat Lengkap Jalan</label><textarea id="alamat" name="alamat" placeholder="Contoh: Jalan Sulatri No. 3 Denpasar" required></textarea></div>
                <div class="input-group"><label for="kecamatan">Kecamatan</label><select id="kecamatan" name="kecamatan" required><option></option><option value="Denpasar Barat">Denpasar Barat</option><option value="Denpasar Selatan">Denpasar Selatan</option><option value="Denpasar Timur">Denpasar Timur</option><option value="Denpasar Utara">Denpasar Utara</option></select></div>
                <div class="input-group"><label for="kelurahan">Kelurahan/Desa</label><input type="text" id="kelurahan" name="kelurahan" placeholder="Contoh: Penatih" required></div>
                <div class="input-group"><label for="banjar">Banjar/Dusun/Lingkungan</label><select id="banjar" name="banjar" required disabled><option></option></select></div>
                <button type="button" class="next-btn" data-current="fieldset-c" data-next="fieldset-d">Selanjutnya ➡️</button>
            </fieldset>

            <fieldset id="fieldset-d" style="display:none;">
                <legend><strong>D. Data Orang Tua / Wali</strong></legend>
                <div class="input-group"><label for="namaAyah">Nama Ayah</label><input type="text" id="namaAyah" name="namaAyah" required></div>
                <div class="input-group"><label for="namaIbu">Nama Ibu</label><input type="text" id="namaIbu" name="namaIbu" required></div>
                <div class="input-group"><label for="noHP">Nomor HP/WhatsApp Aktif</label><input type="text" id="noHP" name="noHP" placeholder="Contoh: 081234567890" required></div>
                <div class="input-group"><label for="email">Email</label><input type="email" id="email" name="email" placeholder="Contoh: orangtua@mail.com"></div>
                <button type="button" class="next-btn" data-current="fieldset-d" data-next="fieldset-e">Selanjutnya ➡️</button>
            </fieldset>

            <fieldset id="fieldset-e" style="display:none;">
                <legend><strong>E. Pilihan Sekolah</strong></legend>
                <div class="input-group"><label for="jalurPmb">Jalur Penerimaan Murid Baru (PMB)</label><select id="jalurPmb" name="jalurPmb" required disabled><option></option></select></div>
                <div class="input-group"><label for="pilihanSekolah1">Pilihan Sekolah 1 (Wajib)</label><select id="pilihanSekolah1" name="pilihanSekolah1" required disabled><option></option></select></div>
                <div class="input-group"><label for="pilihanSekolah2">Pilihan Sekolah 2 (Alternatif)</label><select id="pilihanSekolah2" name="pilihanSekolah2" disabled><option></option></select></div>
                <div class="input-group"><label for="pilihanSekolah3">Pilihan Sekolah 3 (Alternatif)</label><select id="pilihanSekolah3" name="pilihanSekolah3" disabled><option></option></select></div>
                <div class="button-group">
                    <button type="submit" class="submit-btn">Kirim & Unduh Bukti Daftar 🚀</button>
                </div>
            </fieldset>
        </form>
    </div>

    <div class="popup-overlay" id="popup-modal">
        <div class="popup-content" id="popup-content-box">
            <span class="close-btn" id="popup-close-btn">&times;</span>
            <div id="popup-icon" class="popup-icon"></div>
            <div id="popup-message"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        // PENTING: Ganti dengan URL Web App Anda yang sudah di-deploy
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzg3D5N2LHCFF7oiFpgndRf5hBrbuMnReaOUCOlYGAh8suyjG7EYb3CycNF28DIGb8/exec'; 
        
        const form = document.getElementById('pendaftaranForm');
        const submitButton = form.querySelector('.submit-btn');
        let allSchools = [];
        let allSchoolNames = [];
        
        const popupModal = document.getElementById('popup-modal');
        const popupContentBox = document.getElementById('popup-content-box');
        const popupIcon = document.getElementById('popup-icon');
        const popupMessage = document.getElementById('popup-message');
        const popupCloseBtn = document.getElementById('popup-close-btn');

        const icons = {
            success: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#28a745" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>`,
            error: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#dc3545" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/></svg>`,
            loading: `<div class="spinner"></div>`
        };

        function showPopup(message, type = 'success') {
            popupMessage.innerHTML = message;
            popupIcon.innerHTML = icons[type] || '';
            popupCloseBtn.style.display = (type === 'loading') ? 'none' : 'block';
            popupModal.style.display = 'flex';
            setTimeout(() => popupContentBox.classList.add('show'), 10);
        }

        function hidePopup() {
            popupContentBox.classList.remove('show');
            setTimeout(() => popupModal.style.display = 'none', 300);
        }

        popupCloseBtn.addEventListener('click', hidePopup);
        popupModal.addEventListener('click', (e) => {
            if (e.target === popupModal && popupCloseBtn.style.display !== 'none') {
                hidePopup();
            }
        });
        
        function validateSection(fieldsetId) {
            const section = document.getElementById(fieldsetId);
            const inputs = section.querySelectorAll('input[required], select[required], textarea[required]');
            for (let input of inputs) {
                if (!input.value || (input.type === 'checkbox' && !input.checked)) {
                    showPopup(`Harap isi semua kolom yang wajib di bagian ini. Kolom '${$(input).prev('label').text()}' masih kosong.`, 'error');
                    input.focus();
                    return false;
                }
            }
            return true;
        }

        function handleNextStep(e) {
            const currentFielsetId = e.target.dataset.current;
            const nextFieldsetId = e.target.dataset.next;

            if (validateSection(currentFielsetId)) {
                $(`#${nextFieldsetId}`).slideDown();
                $(e.target).hide();
            }
        }
        
        document.querySelectorAll('.next-btn').forEach(button => {
            button.addEventListener('click', handleNextStep);
        });
        
        function updatePilihanSekolah1() {
            const jalur = $('#jalurPmb').val();
            const selectedBanjar = $('#banjar').val();
            const pilihan1 = $('#pilihanSekolah1');

            pilihan1.empty().append(new Option()).trigger('change');

            if (jalur === 'Mutasi') {
                allSchoolNames.forEach(s => pilihan1.append(new Option(s, s, false, false)));
                pilihan1.prop('disabled', false).select2({ placeholder: "Pilih sekolah (Jalur Mutasi)" });
            } else {
                if (selectedBanjar) {
                    const filteredSchools = allSchools.filter(s => s.banjar === selectedBanjar).map(s => s.nama);
                    if (filteredSchools.length > 0) {
                        filteredSchools.forEach(s => pilihan1.append(new Option(s, s, false, false)));
                        pilihan1.prop('disabled', false).select2({ placeholder: "Pilih sekolah sesuai banjar" });
                    } else {
                         pilihan1.prop('disabled', true).select2({ placeholder: "Tidak ada sekolah di banjar ini" });
                    }
                } else {
                    pilihan1.prop('disabled', true).select2({ placeholder: "Pilih banjar terlebih dahulu" });
                }
            }
        }
        
        const handleEdit = () => {
             const nikToEdit = prompt("Untuk mengedit data, masukkan NIK 16 digit yang terdaftar:");
            if (!nikToEdit || !/^\d{16}$/.test(nikToEdit)) {
                if(nikToEdit) alert("NIK tidak valid. Harap masukkan 16 digit angka.");
                return;
            }
            
            showPopup('Mencari data...', 'loading');

            fetch(`${scriptURL}?action=edit&nik=${nikToEdit}`)
                .then(res => res.json())
                .then(response => {
                    if(response.result === 'success' && response.data) {
                        const data = response.data;
                        Object.keys(data).forEach(key => {
                            const el = form.elements[key];
                            if (el) {
                                if (el.tagName === 'SELECT') {
                                    $(`#${el.id}`).val(data[key]).trigger('change');
                                } else {
                                    el.value = data[key];
                                }
                            }
                        });

                        // PERUBAHAN: Kosongkan input token saat data berhasil dimuat
                        $('#token').val('');
                        
                        $('#editNik').val(nikToEdit);
                        $('#nik').prop('readonly', true);
                        submitButton.disabled = false;
                        
                        $('fieldset').slideDown();
                        $('.next-btn').hide();
                        $('.edit-trigger').hide(); 
                        
                        showPopup("Data ditemukan. Silakan edit dan kirim ulang.", 'success');
                    } else {
                        showPopup(`Data dengan NIK ${nikToEdit} tidak ditemukan.`, 'error');
                    }
                })
                .catch(err => {
                    console.error("Error fetching edit data:", err);
                    showPopup("Terjadi kesalahan saat mengambil data.", 'error');
                });
        }

        $(document).ready(function() {
            $('input[required], select[required], textarea[required]').each(function() {
                $('label[for="' + this.id + '"]').addClass('is-required');
            });
            
            $('.edit-trigger').on('click', handleEdit);
            
            $('#jenisKelamin, #provinsi').select2();
            $('#kecamatan').select2({ placeholder: "Pilih Kecamatan" });
            $('#kategoriKK').select2({ placeholder: "Pilih Kategori KK" });
            $('#jalurPmb').select2({ placeholder: "Pilih kategori KK dahulu" });
            const banjarSelect = $('#banjar').select2({ placeholder: "Memuat data banjar..." });
            const pilihan1 = $('#pilihanSekolah1').select2({ placeholder: "Pilih banjar terlebih dahulu" });
            const pilihan2 = $('#pilihanSekolah2').select2({ placeholder: "Memuat data sekolah..." });
            const pilihan3 = $('#pilihanSekolah3').select2({ placeholder: "Memuat data sekolah..." });

            fetch(scriptURL + '?action=getInitialData')
                .then(res => res.json())
                .then(response => {
                    if (response.result === 'success') {
                        allSchools = response.schools;
                        allSchoolNames = [...new Set(allSchools.map(s => s.nama))];
                        const allBanjars = response.banjars;

                        banjarSelect.empty().append(new Option());
                        allBanjars.forEach(b => banjarSelect.append(new Option(b, b, false, false)));
                        banjarSelect.prop('disabled', false).select2({ placeholder: "Cari & pilih banjar" });
                        
                        [pilihan2, pilihan3].forEach(sel => {
                            sel.empty().append(new Option());
                            allSchoolNames.forEach(s => sel.append(new Option(s, s, false, false)));
                            sel.prop('disabled', false).select2({ placeholder: "Cari & pilih sekolah" });
                        });
                    } else { throw new Error('Gagal memuat data awal.'); }
                }).catch(err => {
                    console.error('Error fetching data:', err);
                    showPopup('Gagal memuat data dropdown. Coba refresh halaman.', 'error');
                });
            
            $('#token').on('blur', function() {
                const tokenInput = $(this);
                const token = tokenInput.val().toUpperCase();
                const nextBtn = $('#next-to-b');
                const editBtn = $('.edit-trigger'); 
                
                tokenInput.val(token);
                nextBtn.prop('disabled', true);
                editBtn.prop('disabled', true); 

                if (!tokenInput[0].checkValidity()) {
                    showPopup('Token tidak valid. Pastikan 8 karakter kombinasi huruf kapital dan angka.', 'error');
                    return;
                }
                
                showPopup('Memeriksa Token...', 'loading');
                fetch(`${scriptURL}?action=checkToken&token=${token}`)
                    .then(res => res.json())
                    .then(response => {
                        if (response.result === 'success' && response.valid) {
                            showPopup('Token valid. Silakan lanjutkan pendaftaran.', 'success');
                            nextBtn.prop('disabled', false);
                            editBtn.prop('disabled', false); 
                        } else {
                            showPopup('Token tidak ditemukan. Pendaftaran hanya bisa dilakukan oleh pihak sekolah atau cek kembali token Anda.', 'error');
                        }
                    })
                    .catch(err => {
                        console.error('Error checking token:', err);
                        showPopup('Gagal memeriksa token. Coba lagi.', 'error');
                    });
            });

            $('#kategoriKK').on('change', function() {
                const kategori = $(this).val();
                const jalurSelect = $('#jalurPmb');
                jalurSelect.empty().append(new Option());

                const provinsiGroup = $('#provinsi-group');
                const provinsiInput = $('#provinsi');
                if (kategori === 'KK Luar Denpasar') {
                    provinsiGroup.slideDown();
                    provinsiInput.prop('required', true).prev('label').addClass('is-required');
                } else {
                    provinsiGroup.slideUp();
                    provinsiInput.prop('required', false).prev('label').removeClass('is-required');
                    provinsiInput.val('').trigger('change');
                }

                if (kategori === 'KK Denpasar') {
                    ['Afirmasi', 'Mutasi', 'Domisili'].forEach(j => jalurSelect.append(new Option(j, j)));
                    jalurSelect.prop('disabled', false).select2({ placeholder: "Pilih Jalur PMB" });
                } else if (kategori === 'KK Luar Denpasar') {
                    ['Mutasi', 'Domisili'].forEach(j => jalurSelect.append(new Option(j, j)));
                    jalurSelect.prop('disabled', false).select2({ placeholder: "Pilih Jalur PMB" });
                } else {
                    jalurSelect.prop('disabled', true).select2({ placeholder: "Pilih kategori KK dahulu" });
                }
                updatePilihanSekolah1(); 
            });
            
            $('#jalurPmb, #banjar').on('change', function() {
                updatePilihanSekolah1();
            });

            $('#nik').on('blur', function() {
                const nikInput = $(this);
                const nik = nikInput.val();
                
                if (nikInput.prop('readonly') || !/^\d{16}$/.test(nik)) {
                    return;
                }
                
                showPopup('Memeriksa NIK...', 'loading');

                fetch(`${scriptURL}?action=checkNik&nik=${nik}`)
                    .then(res => res.json())
                    .then(response => {
                        if (response.result === 'success') {
                           if (response.exists) {
                                const message = `NIK sudah terdaftar. Silakan <a href="${response.pdfUrl}" target="_blank">unduh bukti daftar</a> atau klik tombol 'Edit Data' untuk melakukan perubahan.`;
                                showPopup(message, 'error');
                                submitButton.disabled = true; 
                            } else {
                                showPopup('NIK belum terdaftar, silakan lanjutkan pengisian formulir.', 'success');
                                submitButton.disabled = false;
                            }
                        } else {
                            throw new Error('Pemeriksaan NIK gagal.');
                        }
                    })
                    .catch(err => {
                        console.error("Error checking NIK:", err);
                        showPopup('Gagal memeriksa NIK. Periksa koneksi dan coba lagi.', 'error');
                        submitButton.disabled = false;
                    });
            });
        });

        form.addEventListener('submit', e => {
            e.preventDefault();
            if (!validateSection('fieldset-e')) return;

            const s1 = $('#pilihanSekolah1').val();
            const s2 = $('#pilihanSekolah2').val();
            const s3 = $('#pilihanSekolah3').val();
            if (s1 && s2 && s1 === s2) { showPopup('Pilihan Sekolah 1 dan 2 tidak boleh sama.', 'error'); return; }
            if (s1 && s3 && s1 === s3) { showPopup('Pilihan Sekolah 1 dan 3 tidak boleh sama.', 'error'); return; }
            if (s2 && s3 && s2 === s3) { showPopup('Pilihan Sekolah 2 dan 3 tidak boleh sama.', 'error'); return; }
            
            showPopup('Memproses pendaftaran...', 'loading');

            // ========================================================================= //
            // == PERUBAHAN DIMULAI DI SINI UNTUK MEMPERTAHANKAN ANGKA NOL DI DEPAN == //
            // ========================================================================= //
            
            // 1. Buat objek FormData dari form
            const formData = new FormData(form);

            // 2. Ambil nilai dari kolom yang berpotensi memiliki angka 0 di depan
            //const nikValue = formData.get('nik');
            const nisnValue = formData.get('nisn');
            const noHPValue = formData.get('noHP');

            // 3. Tambahkan apostrof (') di awal nilai agar dibaca sebagai TEKS oleh Google Sheets
            //formData.set('nik', `'${nikValue}`);
            if (nisnValue) { // Hanya proses jika NISN diisi
                formData.set('nisn', `'${nisnValue}`);
            }
            formData.set('noHP', `'${noHPValue}`);

            // ========================================================================= //
            // ========================= PERUBAHAN SELESAI ========================= //
            // ========================================================================= //


            // 4. Kirim FormData yang sudah dimodifikasi
            fetch(scriptURL, { method: 'POST', body: formData}) 
                .then(res => res.json())
                .then(data => {
                    if (data.result === 'success' && data.pdfUrl) {
                        const actionText = $('#editNik').val() ? 'diperbarui' : 'didaftarkan';
                        const message = `Data berhasil ${actionText}! <a href="${data.pdfUrl}" target="_blank">Klik di sini untuk mengunduh bukti.</a>`;
                        showPopup(message, 'success');
                        
                        const downloadLink = document.createElement('a');
                        downloadLink.href = data.pdfUrl;
                        downloadLink.target = '_blank';
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                        
                        form.reset();
                        $('select').val(null).trigger('change');
                        $('#editNik').val('');
                        $('#nik').prop('readonly', false);
                        $('fieldset').not('#fieldset-a').hide();
                        $('#fieldset-a').show();
                        $('.next-btn').show();
                        $('#next-to-b').prop('disabled', true);
                        $('.edit-trigger').show().prop('disabled', true);

                    } else {
                        throw new Error(data.error || 'Gagal memproses data atau membuat PDF.');
                    }
                })
                .catch(error => {
                    showPopup(`Terjadi kesalahan! ${error.message}. Silakan coba lagi.`, 'error');
                })
                .finally(() => {
                    submitButton.disabled = false;
                });
        });
    </script>
</body>
</html>
