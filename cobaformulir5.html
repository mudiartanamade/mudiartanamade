<!DOCTYPE html>
<html lang="id">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Formulir Pendaftaran Siswa Baru SD - Kota Denpasar</title>
Â  Â  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
Â  Â Â 
Â  Â  <style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --primary-color: #3C8DBC;
Â  Â  Â  Â  Â  Â  --primary-hover: #367FA9;
Â  Â  Â  Â  Â  Â  --bg-color: #ecf0f5;
Â  Â  Â  Â  Â  Â  --card-bg: #ffffff;
Â  Â  Â  Â  Â  Â  --text-dark: #333;
Â  Â  Â  Â  Â  Â  --text-light: #666; /* Warna teks lebih lembut */
Â  Â  Â  Â  Â  Â  --border-color: #ddd;
Â  Â  Â  Â  Â  Â  --success-color: #00a65a;
Â  Â  Â  Â  Â  Â  --success-hover: #008d4c;
Â  Â  Â  Â  Â  Â  --secondary-color: #6c757d;
Â  Â  Â  Â  Â  Â  --secondary-hover: #5a6268;
Â  Â  Â  Â  }

Â  Â  Â  Â  *, *::before, *::after {
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }

Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
Â  Â  Â  Â  Â  Â  background-color: var(--bg-color);
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  color: var(--text-dark);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  }

Â  Â  Â  Â  #pendaftaranForm {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 800px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Card/Box Component untuk Fieldset --- */
Â  Â  Â  Â  .form-card {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 1px 4px rgba(0,0,0,.1);
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  overflow: hidden; /* Penting agar border-top tidak terpisah */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .card-form-header {
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  padding: 20px 20px 15px 20px;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #f4f4f4;
Â  Â  Â  Â  }
Â  Â  Â  Â  .card-form-header img {
Â  Â  Â  Â  Â  Â  width: 80px;
Â  Â  Â  Â  Â  Â  height: auto;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .card-form-header h2 {
Â  Â  Â  Â  Â  Â  color: var(--primary-hover);
Â  Â  Â  Â  Â  Â  font-size: 24px;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  }
Â  Â  Â  Â  .card-form-header p {
Â  Â  Â  Â  Â  Â  margin-top: 5px;
Â  Â  Â  Â  Â  Â  margin-bottom: 0;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  }

Â  Â  Â  Â  .card-header {
Â  Â  Â  Â  Â  Â  padding: 12px 20px;
Â  Â  Â  Â  Â  Â  background-color: #fafafa;
Â  Â  Â  Â  Â  Â  border-top: 1px solid #f4f4f4;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #f4f4f4;
Â  Â  Â  Â  }
Â  Â  Â  Â  #fieldset-a .card-header {
Â  Â  Â  Â  Â  Â  border-top: none;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  .card-header .card-title {
Â  Â  Â  Â  Â  Â  font-size: 18px;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  color: var(--text-dark);
Â  Â  Â  Â  }
Â  Â  Â  Â  .card-body {
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .card-footer {
Â  Â  Â  Â  Â  Â  padding: 15px 20px;
Â  Â  Â  Â  Â  Â  background-color: #f9f9f9;
Â  Â  Â  Â  Â  Â  border-top: 1px solid #f4f4f4;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .input-group { margin-bottom: 15px; }
Â  Â  Â  Â  .input-group:last-child { margin-bottom: 0; }
Â  Â  Â  Â  .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-light); }
Â  Â  Â  Â  .is-required::after { content: " *"; color: #dc3545; font-weight: bold; }
Â  Â  Â  Â  .input-group input[type=text], .input-group input[type=number], .input-group input[type=date], .input-group input[type=tel], .input-group input[type=email], .input-group select, .input-group textarea, .select2-container { width: 100% !important; }
Â  Â  Â  Â  .input-group input[type=text], .input-group input[type=number], .input-group input[type=date], .input-group input[type=tel], .input-group input[type=email], .input-group textarea {
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .input-group input:focus, .input-group textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 1px var(--primary-color); outline: 0; }
Â  Â  Â  Â  .input-group input:read-only, .input-group select:disabled, .input-group input:disabled { background-color: #e9ecef; cursor: not-allowed; }

Â  Â  Â  Â  .btn {
Â  Â  Â  Â  Â  Â  padding: 10px 18px;
Â  Â  Â  Â  Â  Â  border: 1px solid transparent;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: all .2s;
Â  Â  Â  Â  Â  Â  text-decoration: none;
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn:disabled { cursor: not-allowed; opacity: 0.65; }
Â  Â  Â  Â  .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
Â  Â  Â  Â  .btn-primary:hover { background-color: var(--primary-hover); border-color: var(--primary-hover); }
Â  Â  Â  Â  .btn-secondary { background-color: var(--secondary-color); border-color: var(--secondary-color); }
Â  Â  Â  Â  .btn-secondary:hover { background-color: var(--secondary-hover); border-color: var(--secondary-hover); }
Â  Â  Â  Â  .btn-success { background-color: var(--success-color); border-color: var(--success-color); }
Â  Â  Â  Â  .btn-success:hover { background-color: var(--success-hover); border-color: var(--success-hover); }
Â  Â  Â  Â  .button-group { display: flex; flex-wrap: wrap; gap: 10px; }
Â  Â  Â  Â  .button-group .btn { flex-grow: 1; min-width: 150px; }
Â  Â  Â  Â  .card-footer .btn { width: 100%; }

Â  Â  Â  Â  .select2-container .select2-selection--single { height: 40px !important; padding: 5px 0; border: 1px solid var(--border-color); border-radius: 4px; }
Â  Â  Â  Â  .select2-container--default .select2-selection--single .select2-selection__arrow { height: 38px !important; }
Â  Â  Â  Â  .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 28px !important; }
Â  Â  Â  Â  .select2-dropdown { border: 1px solid var(--border-color); border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,.1); }

Â  Â  Â  Â  .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 15px; }
Â  Â  Â  Â  .popup-content { background: var(--card-bg); padding: 30px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,.2); text-align: center; max-width: 450px; width: 100%; position: relative; transform: scale(.9); opacity: 0; transition: transform .3s ease, opacity .3s ease; }
Â  Â  Â  Â  .popup-content.show { transform: scale(1); opacity: 1; }
Â  Â  Â  Â  .popup-content .close-btn { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: 700; color: #aaa; cursor: pointer; line-height: 1; }
Â  Â  Â  Â  #popup-message { margin-top: 15px; font-size: 16px; line-height: 1.5; color: var(--text-light); }
Â  Â  Â  Â  #popup-message a { color: var(--primary-hover); font-weight: 700; text-decoration: underline; }
Â  Â  Â  Â  #popup-icon { margin-bottom: 15px; min-height: 50px; display: flex; align-items: center; justify-content: center; }
Â  Â  Â  Â  #popup-message .popup-input { margin-top: 15px; padding: 10px; width: 100%; border: 1px solid var(--border-color); border-radius: 4px; font-size: 16px; text-align: center; }
Â  Â  Â  Â  #popup-message .popup-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 1px var(--primary-color); outline: 0; }
Â  Â  Â  Â  #popup-message .popup-button { margin-top: 15px; width: 100%; }

Â  Â  Â  Â  .spinner { width: 48px; height: 48px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
Â  Â  Â  Â  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .page-footer {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  padding: 20px 0 0 0;
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  }

Â  Â  Â  Â  @media (max-width: 600px) {
Â  Â  Â  Â  Â  Â  body { padding: 10px; }
Â  Â  Â  Â  Â  Â  .card-form-header h2 { font-size: 20px; }
Â  Â  Â  Â  Â  Â  .card-body, .card-footer, .card-header, .card-form-header { padding: 15px; }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â  <form name="form-pendaftaran-sd" id="pendaftaranForm">
Â  Â  Â  Â  <input type="hidden" name="editNik" id="editNik">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="form-card" id="fieldset-a">
Â  Â  Â  Â  Â  Â  <div class="card-form-header">
Â  Â  Â  Â  Â  Â  Â  Â  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/Lambang_Kota_Denpasar_%281%29.png/1077px-Lambang_Kota_Denpasar_%281%29.png" alt="Logo Kota Denpasar">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>Formulir Pendaftaran Murid Baru SD Negeri Kota Denpasar</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Tahun Ajaran 2026/2027</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="card-title">A. Verifikasi Admin Sekolah</h3>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card-body">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="token">Masukkan Token</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="token" name="token" pattern="[A-Z0-9]{8}" title="Token harus 8 karakter kombinasi huruf kapital dan angka." required placeholder="Token 8 karakter dari Admin Disdikpora Dps">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card-footer">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="button-group" id="token-verification-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-primary" id="verify-token-btn" style="width: 100%;">âœ”ï¸ Verifikasi Token</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="button-group" id="post-verification-group" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-secondary edit-trigger">âœï¸ Edit Data</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-success next-btn" data-current="fieldset-a" data-next="fieldset-b">Pendaftaran âœ</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="form-card" id="fieldset-b" style="display:none;">
Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="card-title">B. Data Diri Calon Siswa</h3>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card-body">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group"><label for="namaLengkap">Nama Lengkap</label><input type="text" id="namaLengkap" name="namaLengkap" placeholder="Sesuai Akta Kelahiran" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group"><label for="nik">Nomor Induk Kependudukan (NIK)</label><input type="number" id="nik" name="nik" pattern="\d{16}" title="NIK harus terdiri dari 16 digit angka" placeholder="16 digit angka" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group"><label for="nisn">Nomor Induk Siswa Nasional (NISN)</label><input type="number" id="nisn" name="nisn" pattern="\d{10}" title="NISN harus terdiri dari 10 digit angka" placeholder="Jika ada"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group"><label for="jenisKelamin">Jenis Kelamin</label><select id="jenisKelamin" name="jenisKelamin" required><option value="" disabled selected>Pilih Jenis Kelamin</option><option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group"><label for="tempatLahir">Tempat Lahir</label><input type="text" id="tempatLahir" name="tempatLahir" placeholder="Contoh: Denpasar" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group"><label for="tanggalLahir">Tanggal Lahir</label><input type="date" id="tanggalLahir" name="tanggalLahir" required></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card-footer">
Â  Â  Â  Â  Â  Â  Â  Â  Â <button type="button" class="btn btn-success next-btn" data-current="fieldset-b" data-next="fieldset-c">Selanjutnya ğŸ‘‰</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="form-card" id="fieldset-c" style="display:none;">
Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="card-title">C. Alamat Tinggal (Sesuai Dokumen Resmi)</h3>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card-body">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group"><label for="kategoriKK">Kategori KK</label><select id="kategoriKK" name="kategoriKK" required><option></option><option value="KK Denpasar">KK Denpasar</option><option value="KK Luar Denpasar">KK Luar Denpasar</option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group" id="provinsi-group" style="display:none;"><label for="provinsi">Provinsi</label><select id="provinsi" name="provinsi"><option value="" disabled selected>Pilih Provinsi Asal</option><option value="Bali">Bali</option><option value="Luar Bali">Luar Bali</option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group"><label for="alamat">Alamat Lengkap Jalan</label><textarea id="alamat" name="alamat" placeholder="Contoh: Jalan Sulatri No. 3 Denpasar" required></textarea></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group"><label for="kecamatan">Kecamatan</label><select id="kecamatan" name="kecamatan" required><option></option><option value="Denpasar Barat">Denpasar Barat</option><option value="Denpasar Selatan">Denpasar Selatan</option><option value="Denpasar Timur">Denpasar Timur</option><option value="Denpasar Utara">Denpasar Utara</option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group"><label for="kelurahan">Kelurahan/Desa</label><input type="text" id="kelurahan" name="kelurahan" placeholder="Contoh: Penatih" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group"><label for="banjar">Banjar/Dusun/Lingkungan</label><select id="banjar" name="banjar" required disabled><option></option></select></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card-footer">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-success next-btn" data-current="fieldset-c" data-next="fieldset-d">Selanjutnya ğŸ‘‰</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="form-card" id="fieldset-d" style="display:none;">
Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â <h3 class="card-title">D. Data Orang Tua / Wali</h3>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card-body">
Â  Â  Â  Â  Â  Â  Â  Â <div class="input-group"><label for="namaAyah">Nama Ayah</label><input type="text" id="namaAyah" name="namaAyah" required></div>
Â  Â  Â  Â  Â  Â  Â  Â <div class="input-group"><label for="namaIbu">Nama Ibu</label><input type="text" id="namaIbu" name="namaIbu" required></div>
Â  Â  Â  Â  Â  Â  Â  Â <div class="input-group"><label for="noHP">Nomor HP/WhatsApp Aktif</label><input type="tel" id="noHP" name="noHP" placeholder="Contoh: 081234567890" required></div>
Â  Â  Â  Â  Â  Â  Â  Â <div class="input-group"><label for="email">Email</label><input type="email" id="email" name="email" placeholder="Contoh: orangtua@mail.com"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card-footer">
Â  Â  Â  Â  Â  Â  Â  Â <button type="button" class="btn btn-success next-btn" data-current="fieldset-d" data-next="fieldset-e">Selanjutnya ğŸ‘‰</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="form-card" id="fieldset-e" style="display:none;">
Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â <h3 class="card-title">E. Pilihan Sekolah</h3>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card-body">
Â  Â  Â  Â  Â  Â  Â  Â <div class="input-group"><label for="jalurPmb">Jalur Penerimaan Murid Baru (PMB)</label><select id="jalurPmb" name="jalurPmb" required disabled><option></option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â <div class="input-group"><label for="pilihanSekolah1">Pilihan Sekolah 1 (Wajib)</label><select id="pilihanSekolah1" name="pilihanSekolah1" required disabled><option></option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â <div class="input-group"><label for="pilihanSekolah2">Pilihan Sekolah 2 (Alternatif)</label><select id="pilihanSekolah2" name="pilihanSekolah2" disabled><option></option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â <div class="input-group"><label for="pilihanSekolah3">Pilihan Sekolah 3 (Alternatif)</label><select id="pilihanSekolah3" name="pilihanSekolah3" disabled><option></option></select></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card-footer">
Â  Â  Â  Â  Â  Â  Â  Â <button type="submit" class="btn btn-primary submit-btn">Kirim & Unduh Bukti Daftar ğŸš€</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </form>
Â  Â Â 
Â  Â  <footer class="page-footer">
Â  Â  Â  Â  SPMB <i>Online</i> SD Negeri Kota Denpasar Â© 2026
Â  Â  </footer>
Â  Â Â 
Â  Â  <div class="popup-overlay" id="popup-modal">
Â  Â  Â  Â  <div class="popup-content" id="popup-content-box">
Â  Â  Â  Â  Â  Â  <span class="close-btn" id="popup-close-btn">&times;</span>
Â  Â  Â  Â  Â  Â  <div id="popup-icon" class="popup-icon"></div>
Â  Â  Â  Â  Â  Â  <div id="popup-message"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
Â  Â Â 
Â  Â  <script>
Â  Â  Â  Â  const scriptURL = 'https://script.google.com/macros/s/AKfycbzg3D5N2LHCFF7oiFpgndRf5hBrbuMnReaOUCOlYGAh8suyjG7EYb3CycNF28DIGb8/exec';Â 
Â  Â  Â  Â  const form = document.getElementById('pendaftaranForm');
Â  Â  Â  Â  const submitButton = form.querySelector('.submit-btn');
Â  Â  Â  Â  let allSchools = [];
Â  Â  Â  Â  let allSchoolNames = [];
Â  Â  Â  Â  const popupModal = document.getElementById('popup-modal');
Â  Â  Â  Â  const popupContentBox = document.getElementById('popup-content-box');
Â  Â  Â  Â  const popupIcon = document.getElementById('popup-icon');
Â  Â  Â  Â  const popupMessage = document.getElementById('popup-message');
Â  Â  Â  Â  const popupCloseBtn = document.getElementById('popup-close-btn');

Â  Â  Â  Â  const icons = {
Â  Â  Â  Â  Â  Â  success: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#00a65a" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>`,
Â  Â  Â  Â  Â  Â  error: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#dc3545" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/></svg>`,
Â  Â  Â  Â  Â  Â  loading: `<div class="spinner"></div>`,
Â  Â  Â  Â  Â  Â  edit: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#3C8DBC" class="bi bi-search" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>`
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  function showPopup(message, type = 'success') {
Â  Â  Â  Â  Â  Â  popupMessage.innerHTML = message;
Â  Â  Â  Â  Â  Â  popupIcon.innerHTML = icons[type] || '';
Â  Â  Â  Â  Â  Â  popupCloseBtn.style.display = (type === 'loading') ? 'none' : 'block';
Â  Â  Â  Â  Â  Â  popupModal.style.display = 'flex';
Â  Â  Â  Â  Â  Â  setTimeout(() => popupContentBox.classList.add('show'), 10);
Â  Â  Â  Â  }

Â  Â  Â  Â  function hidePopup() {
Â  Â  Â  Â  Â  Â  popupContentBox.classList.remove('show');
Â  Â  Â  Â  Â  Â  setTimeout(() => popupModal.style.display = 'none', 300);
Â  Â  Â  Â  }

Â  Â  Â  Â  popupCloseBtn.addEventListener('click', hidePopup);
Â  Â  Â  Â  popupModal.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  if (e.target === popupModal && popupCloseBtn.style.display !== 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  hidePopup();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // [PENYEMPURNAAN 2.1] Fungsi validasi disempurnakan dengan parameter 'checkToken'
Â  Â  Â  Â  // Agar bisa membedakan validasi saat klik "Selanjutnya" (token boleh kosong) dan saat "Submit" (token wajib diisi)
Â  Â  Â  Â  function validateSection(fieldsetId, checkToken = false) {
Â  Â  Â  Â  Â  Â  const section = document.getElementById(fieldsetId);
Â  Â  Â  Â  Â  Â  const inputs = section.querySelectorAll('input[required], select[required], textarea[required]');
Â  Â  Â  Â  Â  Â  for (let input of inputs) {
Â  Â  Â  Â  Â  Â  Â  Â  // Saat 'checkToken' false (default), validasi token dilewati. Ini untuk tombol 'next-btn'.
Â  Â  Â  Â  Â  Â  Â  Â  // Saat 'checkToken' true, validasi token akan dijalankan. Ini untuk tombol 'submit-btn'.
Â  Â  Â  Â  Â  Â  Â  Â  if (input.id === 'token' && !checkToken) continue;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!input.value || (input.type === 'checkbox' && !input.checked)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPopup(`Harap isi semua kolom yang wajib di bagian ini. Kolom '${$(input).closest('.input-group').find('label').text()}' masih kosong.`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  input.focus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  section.scrollIntoView({ behavior: 'smooth', block: 'center' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleNextStep(e) {
Â  Â  Â  Â  Â  Â  const currentFielsetId = e.target.dataset.current;
Â  Â  Â  Â  Â  Â  const nextFieldsetId = e.target.dataset.next;
Â  Â  Â  Â  Â  Â  // Memanggil validateSection tanpa argumen kedua, sehingga token tidak divalidasi
Â  Â  Â  Â  Â  Â  if (validateSection(currentFielsetId)) {
Â  Â  Â  Â  Â  Â  Â  Â  $(`#${nextFieldsetId}`).slideDown();
Â  Â  Â  Â  Â  Â  Â  Â  $(e.target).hide();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.querySelectorAll('.next-btn').forEach(button => {
Â  Â  Â  Â  Â  Â  button.addEventListener('click', handleNextStep);
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  function updatePilihanSekolah1() {
Â  Â  Â  Â  Â  Â  const jalur = $('#jalurPmb').val();
Â  Â  Â  Â  Â  Â  const selectedBanjar = $('#banjar').val();
Â  Â  Â  Â  Â  Â  const pilihan1 = $('#pilihanSekolah1');
Â  Â  Â  Â  Â  Â  pilihan1.empty().append(new Option()).trigger('change');
Â  Â  Â  Â  Â  Â  if (jalur === 'Mutasi') {
Â  Â  Â  Â  Â  Â  Â  Â  allSchoolNames.forEach(s => pilihan1.append(new Option(s, s, false, false)));
Â  Â  Â  Â  Â  Â  Â  Â  pilihan1.prop('disabled', false).select2({ placeholder: "Pilih sekolah (Jalur Mutasi)" });
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if (selectedBanjar) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const filteredSchools = allSchools.filter(s => s.banjar === selectedBanjar).map(s => s.nama);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (filteredSchools.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  filteredSchools.forEach(s => pilihan1.append(new Option(s, s, false, false)));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pilihan1.prop('disabled', false).select2({ placeholder: "Pilih sekolah sesuai banjar" });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â pilihan1.prop('disabled', true).select2({ placeholder: "Tidak ada sekolah di banjar ini" });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pilihan1.prop('disabled', true).select2({ placeholder: "Pilih banjar terlebih dahulu" });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const handleEdit = () => {
Â  Â  Â  Â  Â  Â  const popupHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <h4>Cari Data Pendaftar</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <p>Masukkan NIK 16 digit yang sudah terdaftar untuk mengubah data.</p>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="nik-popup-input" class="popup-input" placeholder="Ketik 16 digit NIK di sini..." pattern="\\d{16}" required>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="search-nik-btn" class="btn btn-primary popup-button">ğŸ” Cari Data</button>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  showPopup(popupHTML, 'edit');

Â  Â  Â  Â  Â  Â  const nikInputPopup = document.getElementById('nik-popup-input');
Â  Â  Â  Â  Â  Â  const searchButtonPopup = document.getElementById('search-nik-btn');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  nikInputPopup.focus();

Â  Â  Â  Â  Â  Â  const performSearch = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const nikToEdit = nikInputPopup.value;
Â  Â  Â  Â  Â  Â  Â  Â  if (!/^\d{16}$/.test(nikToEdit)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPopup(`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4>NIK Tidak Valid</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Harap masukkan 16 digit angka NIK yang benar.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="nik-popup-input" class="popup-input" value="${nikToEdit}" placeholder="Ketik 16 digit NIK di sini..." pattern="\\d{16}" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="search-nik-btn" class="btn btn-primary popup-button">ğŸ” Cari Data</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('search-nik-btn').addEventListener('click', performSearch);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nik-popup-input').addEventListener('keypress', function(e) { if (e.key === 'Enter') performSearch(); });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nik-popup-input').focus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showPopup('Mencari data...', 'loading');

Â  Â  Â  Â  Â  Â  Â  Â  fetch(`${scriptURL}?action=edit&nik=${nikToEdit}`)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(res => res.json())
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(response => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(response.result === 'success' && response.data) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = response.data;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(data).forEach(key => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const el = form.elements[key];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (el) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (el.tagName === 'SELECT') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $(`#${el.id}`).val(data[key]).trigger('change');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.value = data[key];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#editNik').val(nikToEdit);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#nik').prop('readonly', true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submitButton.disabled = false;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // [PENYEMPURNAAN 1] Kosongkan dan buka kunci field Token
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ini memaksa admin untuk menginput ulang token mereka saat mengedit
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#token').val('').prop('readonly', false).focus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('.form-card').not('#fieldset-a').slideDown();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('.next-btn').hide();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hidePopup();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPopup("Data ditemukan. Silakan edit formulir, <strong>isi ulang token Anda</strong>, dan kirim ulang.", 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 300);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPopup(`Data dengan NIK <strong>${nikToEdit}</strong> tidak ditemukan. Pastikan NIK sudah benar.`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error fetching edit data:", err);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPopup("Terjadi kesalahan saat mengambil data. Periksa koneksi internet Anda.", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  searchButtonPopup.addEventListener('click', performSearch);
Â  Â  Â  Â  Â  Â  nikInputPopup.addEventListener('keypress', function(e) {
Â  Â  Â  Â  Â  Â  Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault(); // Mencegah submit form jika ada di dalam popup
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  performSearch();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  $(document).ready(function() {
Â  Â  Â  Â  Â  Â  $('input[required], select[required], textarea[required]').each(function() {
Â  Â  Â  Â  Â  Â  Â  Â  $('label[for="' + this.id + '"]').addClass('is-required');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  $('.edit-trigger').on('click', handleEdit);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  $('#jenisKelamin, #provinsi').select2({ minimumResultsForSearch: Infinity });
Â  Â  Â  Â  Â  Â  $('#kecamatan').select2({ placeholder: "Pilih Kecamatan" });
Â  Â  Â  Â  Â  Â  $('#kategoriKK').select2({ placeholder: "Pilih Kategori KK", minimumResultsForSearch: Infinity });
Â  Â  Â  Â  Â  Â  $('#jalurPmb').select2({ placeholder: "Pilih kategori KK dahulu" });
Â  Â  Â  Â  Â  Â  const banjarSelect = $('#banjar').select2({ placeholder: "Memuat data banjar..." });
Â  Â  Â  Â  Â  Â  const pilihan1 = $('#pilihanSekolah1').select2({ placeholder: "Pilih banjar terlebih dahulu" });
Â  Â  Â  Â  Â  Â  const pilihan2 = $('#pilihanSekolah2').select2({ placeholder: "Memuat data sekolah..." });
Â  Â  Â  Â  Â  Â  const pilihan3 = $('#pilihanSekolah3').select2({ placeholder: "Memuat data sekolah..." });

Â  Â  Â  Â  Â  Â  fetch(scriptURL + '?action=getInitialData')
Â  Â  Â  Â  Â  Â  Â  Â  .then(res => res.json())
Â  Â  Â  Â  Â  Â  Â  Â  .then(response => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (response.result === 'success') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allSchools = response.schools;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allSchoolNames = [...new Set(allSchools.map(s => s.nama))];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const allBanjars = response.banjars;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  banjarSelect.empty().append(new Option());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allBanjars.forEach(b => banjarSelect.append(new Option(b, b, false, false)));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  banjarSelect.prop('disabled', false).select2({ placeholder: "Cari & pilih banjar" });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  [pilihan2, pilihan3].forEach(sel => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sel.empty().append(new Option());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allSchoolNames.forEach(s => sel.append(new Option(s, s, false, false)));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sel.prop('disabled', false).select2({ placeholder: "Cari & pilih sekolah" });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else { throw new Error('Gagal memuat data awal.'); }
Â  Â  Â  Â  Â  Â  Â  Â  }).catch(err => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error fetching data:', err);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPopup('Gagal memuat data dropdown. Coba refresh halaman.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  $('#verify-token-btn').on('click', function() {
Â  Â  Â  Â  Â  Â  Â  Â  const tokenInput = $('#token');
Â  Â  Â  Â  Â  Â  Â  Â  const token = tokenInput.val().toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  tokenInput.val(token);

Â  Â  Â  Â  Â  Â  Â  Â  if (!tokenInput[0].checkValidity()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPopup('Token tidak valid. Pastikan 8 karakter kombinasi huruf kapital dan angka.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showPopup('Memeriksa Token...', 'loading');
Â  Â  Â  Â  Â  Â  Â  Â  fetch(`${scriptURL}?action=checkToken&token=${token}`)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(res => res.json())
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(response => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (response.result === 'success' && response.valid) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPopup('Token valid, silakan lanjutkan pendaftaran atau edit data!', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#token-verification-group').hide();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#post-verification-group').css('display', 'flex');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tokenInput.prop('readonly', true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorMessage = 'Maaf, token yang anda masukkan tidak ditemukan, pastikan Anda adalah Admin Sekolah yang memiliki Token yang diberikan oleh Disdikpora Kota Denpasar. Pendaftaran hanya bisa dilakukan oleh Tim SPMB di Sekolah';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPopup(errorMessage, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error checking token:', err);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPopup('Gagal memeriksa token. Periksa koneksi dan coba lagi.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  $('#kategoriKK').on('change', function() {
Â  Â  Â  Â  Â  Â  Â  Â  const kategori = $(this).val();
Â  Â  Â  Â  Â  Â  Â  Â  const jalurSelect = $('#jalurPmb');
Â  Â  Â  Â  Â  Â  Â  Â  jalurSelect.empty().append(new Option());

Â  Â  Â  Â  Â  Â  Â  Â  const provinsiGroup = $('#provinsi-group');
Â  Â  Â  Â  Â  Â  Â  Â  const provinsiInput = $('#provinsi');
Â  Â  Â  Â  Â  Â  Â  Â  if (kategori === 'KK Luar Denpasar') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  provinsiGroup.slideDown();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  provinsiInput.prop('required', true).prev('label').addClass('is-required');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  provinsiGroup.slideUp();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  provinsiInput.prop('required', false).prev('label').removeClass('is-required');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  provinsiInput.val('').trigger('change');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (kategori === 'KK Denpasar') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ['Afirmasi', 'Mutasi', 'Domisili'].forEach(j => jalurSelect.append(new Option(j, j)));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  jalurSelect.prop('disabled', false).select2({ placeholder: "Pilih Jalur PMB" });
Â  Â  Â  Â  Â  Â  Â  Â  } else if (kategori === 'KK Luar Denpasar') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ['Mutasi', 'Domisili'].forEach(j => jalurSelect.append(new Option(j, j)));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  jalurSelect.prop('disabled', false).select2({ placeholder: "Pilih Jalur PMB" });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  jalurSelect.prop('disabled', true).select2({ placeholder: "Pilih kategori KK dahulu" });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  updatePilihanSekolah1();Â 
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  $('#jalurPmb, #banjar').on('change', function() {
Â  Â  Â  Â  Â  Â  Â  Â  updatePilihanSekolah1();
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  $('#nik').on('blur', function() {
Â  Â  Â  Â  Â  Â  Â  Â  const nikInput = $(this);
Â  Â  Â  Â  Â  Â  Â  Â  const nik = nikInput.val();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (nikInput.prop('readonly') || !/^\d{16}$/.test(nik)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showPopup('Memeriksa NIK...', 'loading');

Â  Â  Â  Â  Â  Â  Â  Â  fetch(`${scriptURL}?action=checkNik&nik=${nik}`)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(res => res.json())
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(response => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (response.result === 'success') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (response.exists) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const message = `NIK sudah terdaftar. Silakan <a href="${response.pdfUrl}" target="_blank">unduh bukti daftar</a> atau klik tombol 'Edit Data' untuk melakukan perubahan.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPopup(message, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submitButton.disabled = true;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hidePopup(); // Sembunyikan popup loading jika NIK tersedia
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submitButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â   A Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('Pemeriksaan NIK gagal.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error checking NIK:", err);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPopup('Gagal memeriksa NIK. Periksa koneksi dan coba lagi.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submitButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  form.addEventListener('submit', e => {
Â  Â  Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  Â  Â  // [PENYEMPURNAAN 2.2] Validasi menyeluruh sebelum submit
Â  Â  Â  Â  Â  Â  // Loop semua fieldset yang terlihat untuk divalidasi satu per satu
Â  Â  Â  Â  Â  Â  let isFormValid = true;
Â  Â  Â  Â  Â  Â  const allFieldsets = document.querySelectorAll('.form-card');
Â  Â  Â  Â  Â  Â  for(const fieldset of allFieldsets){
Â  Â  Â  Â  Â  Â  Â  Â  if ($(fieldset).is(':visible')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Untuk fieldset pertama (ID 'fieldset-a'), paksa pemeriksaan token (argumen kedua true)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mustCheckToken = (fieldset.id === 'fieldset-a');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!validateSection(fieldset.id, mustCheckToken)){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isFormValid = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break; // Hentikan loop jika ditemukan error pertama
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (!isFormValid) return; // Hentikan proses jika form tidak valid
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const s1 = $('#pilihanSekolah1').val();
Â  Â  Â  Â  Â  Â  const s2 = $('#pilihanSekolah2').val();
Â  Â  Â  Â  Â  Â  const s3 = $('#pilihanSekolah3').val();
Â  Â  Â  Â  Â  Â  if (s1 && s2 && s1 === s2) { showPopup('Pilihan Sekolah 1 dan 2 tidak boleh sama.', 'error'); return; }
Â  Â  Â  Â  Â  Â  if (s1 && s3 && s1 === s3) { showPopup('Pilihan Sekolah 1 dan 3 tidak boleh sama.', 'error'); return; }
Â  Â  Â  Â  Â  Â  if (s2 && s3 && s2 === s3) { showPopup('Pilihan Sekolah 2 dan 3 tidak boleh sama.', 'error'); return; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showPopup('Memproses pendaftaran...', 'loading');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const formData = new FormData(form);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const nisnValue = formData.get('nisn');
Â  Â  Â  Â  Â  Â  const noHPValue = formData.get('noHP');

Â  Â  Â  Â  Â  Â  if (nisnValue) { formData.set('nisn', `'${nisnValue}`); }
Â  Â  Â  Â  Â  Â  formData.set('noHP', `'${noHPValue}`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  fetch(scriptURL, { method: 'POST', body: formData})Â 
Â  Â  Â  Â  Â  Â  Â  Â  .then(res => res.json())
Â  Â  Â  Â  Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.result === 'success' && data.pdfUrl) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const actionText = $('#editNik').val() ? 'diperbarui' : 'didaftarkan';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const message = `Data berhasil ${actionText}! <a href="${data.pdfUrl}" target="_blank">Klik di sini untuk mengunduh bukti daftar.</a>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPopup(message, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const downloadLink = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadLink.href = data.pdfUrl;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadLink.target = '_blank';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(downloadLink);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadLink.click();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(downloadLink);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  form.reset();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('select').val(null).trigger('change');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#editNik').val('');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#nik').prop('readonly', false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#token').prop('readonly', false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('.form-card').not('#fieldset-a').hide();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#fieldset-a').show();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('.next-btn').show();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#post-verification-group').hide();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#token-verification-group').show();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(data.error || 'Gagal memproses data atau membuat PDF.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPopup(`Terjadi kesalahan! ${error.message}. Silakan coba lagi.`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .finally(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submitButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>
