<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengumuman SPMB SD Negeri Kota Denpasar 2025/2026</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #2c7be5;
            --secondary-color: #f0f4f8;
            --success-color: #00b74a;
            --text-color: #2d3748;
            --light-gray: #f7fafc;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 10px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .header img {
            height: 80px;
            margin-bottom: 10px;
            margin-top: 10px;
        }
        
        .header h1 {
            color: var(--primary-color);
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .header p {
            color: var(--text-color);
            font-size: 16px;
            opacity: 0.8;
        }
        
        .search-box {
            background-color: var(--light-gray);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .search-box h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .input-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        input[type="text"] {
            width: 100%;
            max-width: 400px;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(44, 123, 229, 0.2);
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        button:hover {
            background-color: #1a68d8;
            transform: translateY(-2px);
        }
        
        .result-container {
            display: none;
            margin-top: 30px;
        }
        
        .info-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }
        
        .info-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 6px 15px;
            text-align: left;
            font-weight: 500;
        }
        
        .info-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .info-table tr:last-child td {
            border-bottom: none;
        }
        
        .info-table tr:nth-child(even) {
            background-color: var(--light-gray);
        }
        
        .info-label {
            font-weight: 500;
            width: 30%;
            color: #666;
        }
        
        .info-value {
            font-weight: 400;
        }
        
        .acceptance-box {
            background-color: var(--light-gray);
            border-radius: var(--border-radius);
            padding: 8px;
            margin-top: 15px;
            text-align: center;
            border: 2px dashed var(--primary-color);
            animation: blink 1.5s infinite alternate;
        }
        
        @keyframes blink {
            0% {
                background-color: var(--light-gray);
                border-color: var(--primary-color);
            }
            100% {
                background-color: rgba(0, 183, 74, 0.1);
                border-color: var(--success-color);
            }
        }
        
        .acceptance-title {
            font-size: 18px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .acceptance-school {
            font-size: 28px;
            font-weight: 700;
            color: var(--success-color);
            margin-bottom: 10px;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        .print-btn {
            background-color: #6c757d;
        }
        
        .print-btn:hover {
            background-color: #5a6268;
        }
        
        .no-result {
            text-align: center;
            padding: 15px;
            color: #666;
            display: none;
        }
        
        /* Spinner CSS */
        .spinner-container {
            display: none;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Countdown timer styles */
        .countdown-container {
            text-align: center;
            padding: 30px;
            background-color: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            display: none;
        }
        
        .countdown-title {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .countdown-timer {
            font-size: 32px;
            font-weight: 700;
            color: #d9534f;
            margin-bottom: 20px;
        }
        
        .countdown-message {
            font-size: 18px;
            color: var(--text-color);
        }
        
        /* Print-specific styles */
        @media print {
            body {
                background-color: white;
                padding: 0;
                margin: 0;
            }
            
            .container {
                box-shadow: none;
                padding: 0;
                max-width: 100%;
                margin: 0;
                border-radius: 0;
            }
            
            .search-box, .action-buttons, .no-result, .spinner-container, .countdown-container {
                display: none !important;
            }
            
            .result-container {
                display: block !important;
                margin-top: 0;
            }
            
            .header {
                margin-bottom: 20px;
            }
            
            .info-table {
                box-shadow: none;
                margin-bottom: 10px;
            }
            
            .acceptance-box {
                animation: none;
                margin-top: 20px;
                page-break-inside: avoid;
            }
            
            /* Set A4 size and margins */
            @page {
                size: A4;
                margin: 1cm;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .info-table {
                display: block;
                overflow-x: auto;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .countdown-title {
                font-size: 20px;
            }
            
            .countdown-timer {
                font-size: 28px;
            }
            
            .countdown-message {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="printableArea">
        <div class="header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/9/9c/Lambang_Denpasar_City.png" alt="Logo Kota Denpasar">
            <h1>PENGUMUMAN PENERIMAAN MURID BARU</h1>
            <p>Sekolah Dasar Negeri Kota Denpasar Tahun Ajaran 2025/2026</p>
            <p>-: KK Kota Denpasar :-</p>
        </div>
        
        <!-- Countdown Timer Section -->
        <div class="countdown-container" id="countdownContainer">
            <h2 class="countdown-title">Pengumuman Akan Dibuka Pada:</h2>
            <div class="countdown-timer" id="countdownTimer"></div>
            <p class="countdown-message">Pengumuman penerimaan murid baru SD Negeri Kota Denpasar akan dibuka pada tanggal 27 Juni 2025 pukul 00:01 WITA</p>
        </div>
        
        <!-- Main Content (will be hidden until announcement time) -->
        <div id="mainContent">
            <div class="search-box">
                <h2>Cek Hasil Seleksi Penerimaan Murid Baru</h2>
                <div class="input-group">
                    <input type="text" id="nikInput" placeholder="Masukkan NIK Calon Murid" autocomplete="off">
                    <button id="searchBtn">Cari</button>
                </div>
                <p>Masukkan Nomor Induk Kependudukan (NIK) calon murid untuk melihat hasil seleksi!</p>
                <p><i><p style="color: #FF8C00;">Pengumuman untuk sekolah dapat diunduh melalui <a href="https://s.id/PengumumanKKD">s.id/PengumumanKKD</a><i/></p></p>
            </div>
            
            <div class="spinner-container" id="spinner">
                <div class="spinner"></div>
            </div>
            
            <div class="no-result" id="noResult">
                <p>Data tidak ditemukan. Silakan periksa kembali NIK yang Anda masukkan.</p>
            </div>
            
            <div class="result-container" id="resultContainer">
                <table class="info-table">
                    <thead>
                        <tr>
                            <th colspan="2">Informasi Calon Murid</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="info-label">NIK Calon Murid</td>
                            <td class="info-value" id="nikValue">-</td>
                        </tr>
                        <tr>
                            <td class="info-label">Nomor Pendaftaran</td>
                            <td class="info-value" id="noDaftarValue">-</td>
                        </tr>
                        <tr>
                            <td class="info-label">Nama Calon Murid</td>
                            <td class="info-value" id="namaValue">-</td>
                        </tr>
                        <tr>
                            <td class="info-label">Tempat, Tanggal Lahir</td>
                            <td class="info-value" id="ttlValue">-</td>
                        </tr>
                        <tr>
                            <td class="info-label">Usia</td>
                            <td class="info-value" id="usiaValue">-</td>
                        </tr>
                        <tr>
                            <td class="info-label">Nama Ibu</td>
                            <td class="info-value" id="namaIbuValue">-</td>
                        </tr>
                    </tbody>
                </table>
                
                <table class="info-table">
                    <thead>
                        <tr>
                            <th colspan="2">Informasi Alamat</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="info-label">Alamat Lengkap</td>
                            <td class="info-value" id="alamatValue">-</td>
                        </tr>
                    </tbody>
                </table>
                
                <table class="info-table">
                    <thead>
                        <tr>
                            <th colspan="2">Pilihan Sekolah</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="info-label">Pilihan Sekolah 1</td>
                            <td class="info-value" id="pilihan1Value">-</td>
                        </tr>
                        <tr>
                            <td class="info-label">Pilihan Sekolah 2</td>
                            <td class="info-value" id="pilihan2Value">-</td>
                        </tr>
                        <tr>
                            <td class="info-label">Pilihan Sekolah 3</td>
                            <td class="info-value" id="pilihan3Value">-</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="acceptance-box">
                    <div class="acceptance-title">STATUS PENERIMAAN</div>
                    <div class="acceptance-school" id="diterimaValue">-</div>
                    <div class="info-value" id="keteranganValue">-</div>
                </div>
                
                <div class="action-buttons">
                    <button id="printBtn" class="print-btn">Unduh PDF</button>
                    <button id="newSearchBtn">Cari Data Lain</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inisialisasi variabel global untuk data spreadsheet
        let spreadsheetData = [];
        
        // Waktu pengumuman dibuka (27 Juni 2025 pukul 00:01 WITA)
        const announcementTime = new Date('2025-06-26T17:01:00Z'); // UTC+8 (WITA)
        
        // Fungsi untuk memeriksa apakah pengumuman sudah bisa dibuka
        function checkAnnouncementTime() {
            const now = new Date();
            if (now >= announcementTime) {
                // Jika sudah melewati waktu pengumuman, tampilkan konten utama
                document.getElementById('countdownContainer').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } else {
                // Jika belum, tampilkan countdown timer
                document.getElementById('countdownContainer').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
                startCountdown();
            }
        }
        
        // Fungsi untuk menghitung countdown
        function startCountdown() {
            function updateCountdown() {
                const now = new Date();
                const diff = announcementTime - now;
                
                if (diff <= 0) {
                    // Waktu pengumuman sudah tiba
                    document.getElementById('countdownContainer').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    return;
                }
                
                // Hitung hari, jam, menit, detik
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                // Tampilkan countdown
                document.getElementById('countdownTimer').textContent = 
                    `${days} hari ${hours} jam ${minutes} menit ${seconds} detik`;
                
                // Update setiap detik
                setTimeout(updateCountdown, 1000);
            }
            
            updateCountdown();
        }
        
        // Fungsi untuk memuat data dari Google Sheets
        async function loadSpreadsheetData() {
            try {
                // Ganti dengan URL API Google Sheets Anda atau gunakan Apps Script
                const sheetId = '1-aVgkXjn2YgbwmfG7wDAuZYo7akFk9ejyBIfTL62huQ';
                const sheetName = 'Pengumuman-KKDps';
                const apiKey = 'AIzaSyDB77XJY5CTvQxnbRt42GAf06VT2ePTvXc'; // Ganti dengan API key Anda
                
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}!A1:Z15101?key=${apiKey}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                // Mengubah data menjadi array of objects
                const headers = data.values[0];
                spreadsheetData = data.values.slice(1).map(row => {
                    let obj = {};
                    headers.forEach((header, i) => {
                        obj[header] = row[i] || '-';
                    });
                    return obj;
                });
                
                console.log('Data loaded successfully:', spreadsheetData.length, 'records');
            } catch (error) {
                console.error('Error loading spreadsheet data:', error);
                // Fallback data jika API tidak bekerja
                spreadsheetData = [
                    {
                        "No": "1",
                        "NIKCalonMurid": "1234567890123456",
                        "NoDaftar": "2025-001",
                        "LokasiDaftar": "Online",
                        "TglDaftar": "01/04/2025",
                        "KategoriKK": "Dalam Kota",
                        "JalurPMB": "Zonasi",
                        "NamaCalonMurid": "I Gede Arya Putra",
                        "TempatTglLahir": "Denpasar, 15/07/2019",
                        "UsiaText": "6 tahun 0 bulan",
                        "UsiaNumeric": "6.0",
                        "NamaIbu": "Ni Made Suryati",
                        "NoKK": "1234567890123456",
                        "TglKK": "01/01/2020",
                        "NoWA": "081234567890",
                        "Provinsi": "Bali",
                        "Kab": "Kota Denpasar",
                        "Kec": "Denpasar Selatan",
                        "Desa": "Sanur Kaja",
                        "Banjar": "Banjar Kaja",
                        "Alamat": "Jl. Danau Poso No. 10",
                        "PilihanSek1": "SD Negeri 1 Sanur",
                        "PilihanSek2": "SD Negeri 2 Sanur",
                        "PilihanSek3": "SD Negeri 3 Sanur",
                        "Diterima di": "SD Negeri 1 Sanur",
                        "Keterangan": "Diterima melalui jalur zonasi"
                    }
                ];
            }
        }
        
        // Fungsi untuk mencari data berdasarkan NIK
        function searchByNIK(nik) {
            return spreadsheetData.find(item => item.NIKCalonMurid === nik);
        }
        
        // Fungsi untuk menampilkan hasil pencarian
        function displayResult(data) {
            if (data) {
                document.getElementById('nikValue').textContent = data.NIKCalonMurid;
                document.getElementById('noDaftarValue').textContent = data.NoDaftar;
                document.getElementById('namaValue').textContent = data.NamaCalonMurid;
                document.getElementById('ttlValue').textContent = data.TempatTglLahir;
                document.getElementById('usiaValue').textContent = data.UsiaText;
                document.getElementById('namaIbuValue').textContent = data.NamaIbu;
                
                const alamat = `${data.Alamat}, Banjar ${data.Banjar}, ${data.Desa}, Kec. ${data.Kec}, ${data.Kab}, ${data.Provinsi}`;
                document.getElementById('alamatValue').textContent = alamat;
                
                document.getElementById('pilihan1Value').textContent = data.PilihanSek1;
                document.getElementById('pilihan2Value').textContent = data.PilihanSek2;
                document.getElementById('pilihan3Value').textContent = data.PilihanSek3;
                
                document.getElementById('diterimaValue').textContent = data['Diterima di'];
                document.getElementById('keteranganValue').textContent = data.Keterangan || '-';
                
                document.getElementById('resultContainer').style.display = 'block';
                document.getElementById('noResult').style.display = 'none';
            } else {
                document.getElementById('resultContainer').style.display = 'none';
                document.getElementById('noResult').style.display = 'block';
            }
            
            // Sembunyikan spinner setelah hasil ditampilkan
            document.getElementById('spinner').style.display = 'none';
        }
        
        // Fungsi untuk menghasilkan PDF dan mengunduhnya
        async function generatePDF() {
            // Sembunyikan elemen yang tidak perlu
            const searchBox = document.querySelector('.search-box');
            const actionButtons = document.querySelector('.action-buttons');
            const noResult = document.getElementById('noResult');
            const spinner = document.getElementById('spinner');
            
            const originalDisplay = {
                searchBox: searchBox.style.display,
                actionButtons: actionButtons.style.display,
                noResult: noResult.style.display,
                spinner: spinner.style.display
            };
            
            searchBox.style.display = 'none';
            actionButtons.style.display = 'none';
            noResult.style.display = 'none';
            spinner.style.display = 'none';
            
            // Pastikan result container ditampilkan
            const resultContainer = document.getElementById('resultContainer');
            resultContainer.style.display = 'block';
            
            // Buat clone dari container untuk manipulasi PDF
            const element = document.getElementById('printableArea');
            const clone = element.cloneNode(true);
            
            // Hilangkan elemen yang tidak diinginkan dari clone
            const cloneSearchBox = clone.querySelector('.search-box');
            const cloneActionButtons = clone.querySelector('.action-buttons');
            const cloneNoResult = clone.querySelector('.no-result');
            const cloneSpinner = clone.querySelector('.spinner-container');
            const cloneCountdown = clone.querySelector('.countdown-container');
            
            if (cloneSearchBox) cloneSearchBox.remove();
            if (cloneActionButtons) cloneActionButtons.remove();
            if (cloneNoResult) cloneNoResult.remove();
            if (cloneSpinner) cloneSpinner.remove();
            if (cloneCountdown) cloneCountdown.remove();
            
            // Tambahkan clone ke body sementara
            clone.style.position = 'absolute';
            clone.style.left = '-9999px';
            clone.style.width = '210mm'; // Lebar A4
            document.body.appendChild(clone);
            
            try {
                // Gunakan html2canvas untuk menangkap elemen sebagai gambar
                const canvas = await html2canvas(clone, {
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    scrollX: 0,
                    scrollY: 0
                });
                
                // Hapus clone dari body
                document.body.removeChild(clone);
                
                // Kembalikan tampilan asli
                searchBox.style.display = originalDisplay.searchBox;
                actionButtons.style.display = originalDisplay.actionButtons;
                noResult.style.display = originalDisplay.noResult;
                spinner.style.display = originalDisplay.spinner;
                
                // Buat PDF menggunakan jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Tambahkan margin 1cm
                const margin = 10;
                const pageWidth = pdf.internal.pageSize.getWidth() - 2 * margin;
                const pageHeight = pdf.internal.pageSize.getHeight() - 2 * margin;
                
                // Hitung rasio untuk menyesuaikan gambar dengan halaman A4
                const imgWidth = pageWidth;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Tambahkan gambar ke PDF
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', margin, margin, imgWidth, imgHeight);
                
                // Simpan PDF dengan nama file yang sesuai
                const namaCalon = document.getElementById('namaValue').textContent || 'pengumuman';
                const sekolahDiterima = document.getElementById('diterimaValue').textContent || 'SD';
                const fileName = `Pengumuman SPMB ${namaCalon} - ${sekolahDiterima}.pdf`.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                
                // Unduh PDF
                pdf.save(fileName);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                // Kembalikan tampilan asli jika terjadi error
                searchBox.style.display = originalDisplay.searchBox;
                actionButtons.style.display = originalDisplay.actionButtons;
                noResult.style.display = originalDisplay.noResult;
                spinner.style.display = originalDisplay.spinner;
                document.body.removeChild(clone);
                
                // Fallback ke window.print() jika pembuatan PDF gagal
                window.print();
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Periksa waktu pengumuman
            checkAnnouncementTime();
            
            // Load data spreadsheet
            loadSpreadsheetData();
            
            // Setup event listeners hanya jika pengumuman sudah dibuka
            if (new Date() >= announcementTime) {
                document.getElementById('searchBtn').addEventListener('click', () => {
                    const nik = document.getElementById('nikInput').value.trim();
                    if (nik) {
                        // Tampilkan spinner
                        document.getElementById('spinner').style.display = 'flex';
                        document.getElementById('resultContainer').style.display = 'none';
                        document.getElementById('noResult').style.display = 'none';
                        
                        // Simulasi loading (untuk demo)
                        setTimeout(() => {
                            const result = searchByNIK(nik);
                            displayResult(result);
                        }, 1500);
                    }
                });
                
                document.getElementById('nikInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const nik = document.getElementById('nikInput').value.trim();
                        if (nik) {
                            // Tampilkan spinner
                            document.getElementById('spinner').style.display = 'flex';
                            document.getElementById('resultContainer').style.display = 'none';
                            document.getElementById('noResult').style.display = 'none';
                            
                            // Simulasi loading (untuk demo)
                            setTimeout(() => {
                                const result = searchByNIK(nik);
                                displayResult(result);
                            }, 1500);
                        }
                    }
                });
                
                document.getElementById('printBtn').addEventListener('click', generatePDF);
                
                document.getElementById('newSearchBtn').addEventListener('click', () => {
                    document.getElementById('nikInput').value = '';
                    document.getElementById('resultContainer').style.display = 'none';
                    document.getElementById('noResult').style.display = 'none';
                    document.getElementById('spinner').style.display = 'none';
                    document.getElementById('nikInput').focus();
                });
            }
        });
    </script>
</body>
</html>