<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Pendaftaran Siswa Baru SD - Kota Denpasar</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background-color:#f4f7f6;margin:0;padding:20px;color:#333}
        .form-container{max-width:700px;margin:auto;background-color:#fff;padding:25px 30px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.1);border-top:5px solid #007bff}
        .form-header img{width:100px;height:auto;margin-bottom:10px}
        .form-header h2{color:#007bff;font-size:24px;margin:0}
        fieldset{border:1px solid #ddd;padding:15px;margin-bottom:20px;border-radius:5px}
        legend{font-weight:700;color:#0056b3;padding:0 10px}
        .input-group{margin-bottom:15px}
        .input-group label{display:block;margin-bottom:8px;font-weight:600;color:#555}
        .input-group input[type=text],.input-group input[type=number],.input-group input[type=date],.input-group input[type=tel],.input-group input[type=email],.input-group select,.input-group textarea{width:100%;padding:10px;border-radius:5px;border:1px solid #ccc;box-sizing:border-box;font-size:16px}
        .input-group select:disabled{background-color:#e9ecef;cursor:not-allowed}
        .button-group{display:flex;gap:10px;margin-top:20px}
        .submit-btn, .edit-btn{flex-grow:1;padding:12px;border:none;border-radius:5px;color:#fff;font-size:18px;font-weight:700;cursor:pointer;transition:background-color .3s ease}
        .submit-btn{background-color:#007bff}
        .edit-btn{background-color:#6c757d}
        .submit-btn:hover{background-color:#0056b3}
        .edit-btn:hover{background-color:#5a6268}
        .submit-btn:disabled{background-color:#5a9eeb;cursor:wait}
        #status{text-align:center;margin-top:20px;font-weight:700;padding:15px;border-radius:5px;display:none}
        #status.success{background-color:#e9f7ef;color:#1d6c43;border:1px solid #a3e0c0}
        #status.error{background-color:#fdeeee;color:#b02a2a;border:1px solid #f8c2c2}
        #status a{color:#0056b3;font-weight:700;text-decoration:underline}
        /* Style untuk Select2 */
        .select2-container .select2-selection--single{height:40px!important;padding:4px 0}
        .select2-container--default .select2-selection--single .select2-selection__arrow{height:38px!important}
    </style>
</head>
<body>
    <div class="form-container">
        <center class="form-header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/Lambang_Kota_Denpasar_%281%29.png/1077px-Lambang_Kota_Denpasar_%281%29.png" alt="Logo Kota Denpasar">
            <div>
                <h2>Formulir Pendaftaran Murid Baru SD Negeri Kota Denpasar</h2>
                <p style="text-align:center; margin-top:5px; margin-bottom: 25px;">Tahun Ajaran 2026/2027</p>
            </div>
        </center>
        
        <form name="form-pendaftaran-sd" id="pendaftaranForm">
            <input type="hidden" name="editNik" id="editNik">
            
            <fieldset>
                <legend><strong>A. Data Diri Calon Siswa</strong></legend>
                <div class="input-group"><label for="namaLengkap">Nama Lengkap</label><input type="text" id="namaLengkap" name="namaLengkap" placeholder="Sesuai Akta Kelahiran" required></div>
                <div class="input-group"><label for="nik">Nomor Induk Kependudukan (NIK)</label><input type="text" id="nik" name="nik" pattern="\d{16}" title="NIK harus terdiri dari 16 digit angka" placeholder="16 digit angka" required></div>
                <div class="input-group"><label for="nisn">Nomor Induk Siswa Nasional (NISN)</label><input type="text" id="nisn" name="nisn" pattern="\d{10}" title="NISN harus terdiri dari 10 digit angka" placeholder="Jika ada"></div>
                <div class="input-group"><label for="jenisKelamin">Jenis Kelamin</label><select id="jenisKelamin" name="jenisKelamin" required><option value="" disabled selected>Pilih Jenis Kelamin</option><option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option></select></div>
                <div class="input-group"><label for="tempatLahir">Tempat Lahir</label><input type="text" id="tempatLahir" name="tempatLahir" placeholder="Contoh: Denpasar" required></div>
                <div class="input-group"><label for="tanggalLahir">Tanggal Lahir</label><input type="date" id="tanggalLahir" name="tanggalLahir" required></div>
            </fieldset>

            <fieldset>
                <legend><strong>B. Alamat Tinggal (Sesuai KK)</strong></legend>
                 <div class="input-group"><label for="kategoriKK">Kategori KK</label><select id="kategoriKK" name="kategoriKK" required><option></option><option value="KK Denpasar">KK Denpasar</option><option value="KK Luar Denpasar">KK Luar Denpasar</option></select></div>
                <div class="input-group"><label for="alamat">Alamat Lengkap Jalan</label><textarea id="alamat" name="alamat" placeholder="Contoh: Jalan Sulatri No. 3 Denpasar" required></textarea></div>
                <div class="input-group"><label for="kecamatan">Kecamatan</label><select id="kecamatan" name="kecamatan" required><option></option><option value="Denpasar Barat">Denpasar Barat</option><option value="Denpasar Selatan">Denpasar Selatan</option><option value="Denpasar Timur">Denpasar Timur</option><option value="Denpasar Utara">Denpasar Utara</option></select></div>
                <div class="input-group"><label for="kelurahan">Kelurahan/Desa</label><input type="text" id="kelurahan" name="kelurahan" placeholder="Contoh: Penatih" required></div>
                <div class="input-group"><label for="banjar">Banjar/Dusun/Lingkungan</label><select id="banjar" name="banjar" required disabled><option></option></select></div>
            </fieldset>

            <fieldset>
                <legend><strong>C. Data Orang Tua / Wali</strong></legend>
                <div class="input-group"><label for="namaAyah">Nama Ayah</label><input type="text" id="namaAyah" name="namaAyah" required></div>
                <div class="input-group"><label for="namaIbu">Nama Ibu</label><input type="text" id="namaIbu" name="namaIbu" required></div>
                <div class="input-group"><label for="noHP">Nomor HP/WhatsApp Aktif</label><input type="tel" id="noHP" name="noHP" placeholder="Contoh: 081234567890" required></div>
                <div class="input-group"><label for="email">Email</label><input type="email" id="email" name="email" placeholder="Contoh: orangtua@mail.com"></div>
            </fieldset>

            <fieldset>
                <legend><strong>D. Pilihan Sekolah</strong></legend>
                 <div class="input-group"><label for="jalurPmb">Jalur Penerimaan Murid Baru (PMB)</label><select id="jalurPmb" name="jalurPmb" required disabled><option></option></select></div>
                <div class="input-group"><label for="pilihanSekolah1">Pilihan Sekolah 1 (Sesuai Banjar)</label><select id="pilihanSekolah1" name="pilihanSekolah1" required disabled><option></option></select></div>
                <div class="input-group"><label for="pilihanSekolah2">Pilihan Sekolah 2 (Alternatif)</label><select id="pilihanSekolah2" name="pilihanSekolah2" required disabled><option></option></select></div>
                <div class="input-group"><label for="pilihanSekolah3">Pilihan Sekolah 3 (Alternatif)</label><select id="pilihanSekolah3" name="pilihanSekolah3" required disabled><option></option></select></div>
            </fieldset>
            
            <div class="button-group">
                <button type="button" class="edit-btn" id="editBtn">‚úèÔ∏è Edit Data</button>
                <button type="submit" class="submit-btn">Kirim & Unduh Bukti Daftar üöÄ</button>
            </div>
            <div id="status"></div>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        // GANTI DENGAN URL WEB APP ANDA
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxrlV9KNqnxpMJhuZs9AsYmzKTpZIWkG4spq248ERupmeE5XiF1KsPf0Ul2vHiIevKf/exec'; 
        
        const form = document.getElementById('pendaftaranForm');
        const statusDiv = document.getElementById('status');
        const submitButton = form.querySelector('.submit-btn');
        const editButton = document.getElementById('editBtn');
        let allSchools = [];

        $(document).ready(function() {
            // Inisialisasi Select2
            $('#kecamatan').select2({ placeholder: "Pilih Kecamatan" });
            $('#kategoriKK').select2({ placeholder: "Pilih Kategori KK" });
            $('#jalurPmb').select2({ placeholder: "Pilih kategori KK dahulu" });
            const banjarSelect = $('#banjar').select2({ placeholder: "Memuat data banjar..." });
            const pilihan1 = $('#pilihanSekolah1').select2({ placeholder: "Pilih banjar terlebih dahulu" });
            const pilihan2 = $('#pilihanSekolah2').select2({ placeholder: "Memuat data sekolah..." });
            const pilihan3 = $('#pilihanSekolah3').select2({ placeholder: "Memuat data sekolah..." });

            // Ambil data dari Apps Script
            fetch(scriptURL + '?action=getInitialData')
                .then(res => res.json())
                .then(response => {
                    if (response.result === 'success') {
                        allSchools = response.schools;
                        const allSchoolNames = [...new Set(allSchools.map(s => s.nama))];
                        const allBanjars = response.banjars;

                        banjarSelect.empty().append(new Option());
                        allBanjars.forEach(b => banjarSelect.append(new Option(b, b, false, false)));
                        banjarSelect.attr('disabled', false).select2({ placeholder: "Cari & pilih banjar" });
                        
                        [pilihan2, pilihan3].forEach(sel => {
                            sel.empty().append(new Option());
                            allSchoolNames.forEach(s => sel.append(new Option(s, s, false, false)));
                            sel.attr('disabled', false).select2({ placeholder: "Cari & pilih sekolah" });
                        });
                    } else { throw new Error('Gagal memuat data awal.'); }
                }).catch(err => {
                    console.error('Error fetching data:', err);
                    statusDiv.textContent = 'Gagal memuat data dropdown. Coba refresh halaman.';
                    statusDiv.className = 'error';
                    statusDiv.style.display = 'block';
                });

            // Event saat Kategori KK dipilih
            $('#kategoriKK').on('change', function() {
                const kategori = $(this).val();
                const jalurSelect = $('#jalurPmb');
                jalurSelect.empty().append(new Option());

                if (kategori === 'KK Denpasar') {
                    ['Afirmasi', 'Mutasi', 'Domisili'].forEach(j => jalurSelect.append(new Option(j, j)));
                    jalurSelect.attr('disabled', false).select2({ placeholder: "Pilih Jalur PMB" });
                } else if (kategori === 'KK Luar Denpasar') {
                    ['Mutasi', 'Domisili'].forEach(j => jalurSelect.append(new Option(j, j)));
                    jalurSelect.attr('disabled', false).select2({ placeholder: "Pilih Jalur PMB" });
                } else {
                    jalurSelect.attr('disabled', true).select2({ placeholder: "Pilih kategori KK dahulu" });
                }
            });
            
            // Event saat Banjar dipilih
            banjarSelect.on('change', function() {
                const selectedBanjar = $(this).val();
                pilihan1.empty().append(new Option()).trigger('change');
                if (selectedBanjar) {
                    const filteredSchools = allSchools.filter(s => s.banjar === selectedBanjar).map(s => s.nama);
                    filteredSchools.forEach(s => pilihan1.append(new Option(s, s, false, false)));
                    pilihan1.attr('disabled', false).select2({ placeholder: "Cari & pilih sekolah" });
                } else {
                    pilihan1.attr('disabled', true).select2({ placeholder: "Pilih banjar terlebih dahulu" });
                }
            });
        });
        
        // Event tombol Edit Data
        editButton.addEventListener('click', () => {
            const nikToEdit = prompt("Untuk mengedit data, masukkan NIK 16 digit yang terdaftar:");
            if (!nikToEdit || !/^\d{16}$/.test(nikToEdit)) {
                if(nikToEdit) alert("NIK tidak valid. Harap masukkan 16 digit angka.");
                return;
            }
            
            statusDiv.innerHTML = "Mencari data...";
            statusDiv.className = '';
            statusDiv.style.display = 'block';

            fetch(`${scriptURL}?action=edit&nik=${nikToEdit}`)
                .then(res => res.json())
                .then(response => {
                    if(response.result === 'success' && response.data) {
                        const data = response.data;
                        // Isi semua field form
                        Object.keys(data).forEach(key => {
                            const el = form.elements[key];
                            if (el) {
                                if (el.tagName === 'SELECT') {
                                    $(`#${el.id}`).val(data[key]).trigger('change'); // Trigger change untuk select2
                                } else {
                                    el.value = data[key];
                                }
                            }
                        });
                        $('#editNik').val(nikToEdit); // Set hidden input untuk mode edit
                        $('#nik').prop('readonly', true); // Kunci NIK agar tidak bisa diubah
                        statusDiv.innerHTML = "‚úÖ Data ditemukan. Silakan edit dan kirim ulang.";
                        statusDiv.className = 'success';
                    } else {
                        statusDiv.innerHTML = `‚ùå Data dengan NIK ${nikToEdit} tidak ditemukan.`;
                        statusDiv.className = 'error';
                    }
                })
                .catch(err => {
                    console.error("Error fetching edit data:", err);
                    statusDiv.innerHTML = "‚ùå Terjadi kesalahan saat mengambil data.";
                    statusDiv.className = 'error';
                });
        });

        // Event saat form disubmit
        form.addEventListener('submit', e => {
            e.preventDefault();

            // Validasi Pilihan Sekolah tidak boleh sama
            const s1 = $('#pilihanSekolah1').val();
            const s2 = $('#pilihanSekolah2').val();
            const s3 = $('#pilihanSekolah3').val();
            if (s1 && s2 && s1 === s2) { alert('Pilihan Sekolah 1 dan 2 tidak boleh sama.'); return; }
            if (s1 && s3 && s1 === s3) { alert('Pilihan Sekolah 1 dan 3 tidak boleh sama.'); return; }
            if (s2 && s3 && s2 === s3) { alert('Pilihan Sekolah 2 dan 3 tidak boleh sama.'); return; }

            submitButton.disabled = true;
            submitButton.innerText = 'MEMPROSES... ‚è≥';
            statusDiv.style.display = 'none';

            fetch(scriptURL, { method: 'POST', body: new FormData(form)})
                .then(res => res.json())
                .then(data => {
                    if (data.result === 'success' && data.pdfUrl) {
                        const actionText = $('#editNik').val() ? 'diperbarui' : 'didaftarkan';
                        statusDiv.innerHTML = `‚úÖ Data berhasil ${actionText}! <a href="${data.pdfUrl}" target="_blank">Klik di sini untuk mengunduh bukti.</a>`;
                        statusDiv.className = 'success';
                        
                        const downloadLink = document.createElement('a');
                        downloadLink.href = data.pdfUrl;
                        downloadLink.target = '_blank';
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                        
                        form.reset();
                        $('select').val(null).trigger('change'); // Reset Select2
                        $('#editNik').val(''); // Clear edit mode
                        $('#nik').prop('readonly', false); // Buka kembali field NIK
                    } else {
                        throw new Error(data.error || 'Gagal memproses data atau membuat PDF.');
                    }
                })
                .catch(error => {
                    statusDiv.innerHTML = `‚ùå Terjadi kesalahan! ${error.message}. Silakan coba lagi.`;
                    statusDiv.className = 'error';
                })
                .finally(() => {
                    statusDiv.style.display = 'block';
                    submitButton.disabled = false;
                    submitButton.innerText = 'Kirim & Unduh Bukti Daftar üöÄ';
                });
        });
    </script>
</body>
</html>
